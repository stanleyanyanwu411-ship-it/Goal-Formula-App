<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Goal Range Index Calculator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex items-center justify-center bg-gray-50">

    <div id="appContainer" class="w-full max-w-xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Custom Goal Range Index Calculator</h1>
            <p class="text-gray-500 mt-2">Input match details to apply your proprietary formula ($R$).</p>
        </header>

        <!-- Input Card -->
        <div class="card bg-white p-6 rounded-xl border border-green-100 mb-8">
            <div class="grid grid-cols-1 gap-4">
                <input type="text" id="homeTeam" placeholder="Team 1 (Home)"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150"
                       aria-label="Home Team Name">
                <input type="text" id="awayTeam" placeholder="Team 2 (Away)"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150"
                       aria-label="Away Team Name">
                
                <!-- Tournament Dropdown -->
                <select id="tournamentSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150" aria-label="Select Tournament">
                    <option value="" disabled selected>Select Current Tournament/League</option>
                    <option value="English Premier League">English Premier League</option>
                    <option value="Spanish La Liga">Spanish La Liga</option>
                    <option value="German Bundesliga">German Bundesliga</option>
                    <option value="Italian Serie A">Italian Serie A</option>
                    <option value="French Ligue 1">French Ligue 1</option>
                    <option value="UEFA Champions League">UEFA Champions League</option>
                    <option value="UEFA Europa League">UEFA Europa League</option>
                    <option value="Copa Libertadores">Copa Libertadores</option>
                    <option value="Major League Soccer (MLS)">Major League Soccer (MLS)</option>
                    <option value="Other Domestic League">Other Domestic League (Specify in Team Name if possible)</option>
                </select>
            </div>

            <button id="calculateBtn"
                    class="mt-6 w-full py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150 ease-in-out disabled:bg-green-300">
                Calculate Goal Range Index ($R$)
            </button>
        </div>

        <!-- Result Card -->
        <div id="resultCard" class="card bg-white p-6 rounded-xl border border-gray-200 hidden">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                Prediction Result
                <svg id="loadingIcon" class="animate-spin ml-3 h-5 w-5 text-green-500 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </h2>

            <div id="predictionOutput" class="text-gray-700 leading-relaxed min-h-[50px]">
                <!-- Results will be displayed here -->
            </div>

            <div id="citationSection" class="mt-4 pt-4 border-t border-gray-100 hidden">
                <p class="text-sm font-medium text-gray-500 mb-2">Sources (Data used for calculation):</p>
                <ul id="sourcesList" class="space-y-1 text-xs text-gray-500">
                    <!-- Sources will be listed here -->
                </ul>
            </div>
            
            <div id="errorBox" class="text-sm text-red-600 bg-red-50 p-3 rounded-lg mt-4 hidden">
                <!-- Errors will be displayed here -->
            </div>
        </div>
        
        <!-- User ID for mandatory requirement -->
        <p id="userIdDisplay" class="text-xs text-gray-400 mt-4 text-center">User ID: Loading...</p>
    </div>


    <script type="module">
        // Mandatory Firebase imports (Required by the environment, though not used for simple calculation)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase logging level to Debug
        setLogLevel('debug');
        
        let db, auth;
        let userId = 'loading';
        const apiKey = ""; // API key is left empty, handled by the environment

        // --- 1. Firebase Initialization and Authentication (MANDATORY BOILERPLATE) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                    }
                }
                document.getElementById('userIdDisplay').textContent = `User ID: ${userId}`;
            });
        }

        // --- 2. Core Logic: Gemini API Call and UI Handling ---

        const calculateBtn = document.getElementById('calculateBtn');
        const homeTeamInput = document.getElementById('homeTeam');
        const awayTeamInput = document.getElementById('awayTeam');
        const tournamentSelect = document.getElementById('tournamentSelect');
        const resultCard = document.getElementById('resultCard');
        const predictionOutput = document.getElementById('predictionOutput');
        const sourcesList = document.getElementById('sourcesList');
        const citationSection = document.getElementById('citationSection');
        const errorBox = document.getElementById('errorBox');
        const loadingIcon = document.getElementById('loadingIcon');

        calculateBtn.addEventListener('click', () => {
            const homeTeam = homeTeamInput.value.trim();
            const awayTeam = awayTeamInput.value.trim();
            const tournament = tournamentSelect.value;

            if (!homeTeam || !awayTeam) {
                displayError("Please enter names for both Team 1 and Team 2.");
                return;
            }
            if (!tournament) {
                 displayError("Please select the current Tournament/League from the dropdown.");
                 return;
            }

            clearResults();
            resultCard.classList.remove('hidden');
            setLoading(true);
            callGeminiAPI(homeTeam, awayTeam, tournament);
        });

        function setLoading(isLoading) {
            calculateBtn.disabled = isLoading;
            calculateBtn.textContent = isLoading ? 'Calculating Index...' : 'Calculate Goal Range Index ($R$)';
            loadingIcon.classList.toggle('hidden', !isLoading);
            errorBox.classList.add('hidden');
        }

        function clearResults() {
            predictionOutput.innerHTML = '';
            sourcesList.innerHTML = '';
            citationSection.classList.add('hidden');
            errorBox.classList.add('hidden');
        }

        function displayError(message) {
            predictionOutput.innerHTML = '<p class="text-red-500 font-semibold">Calculation Failed</p>';
            errorBox.textContent = message;
            errorBox.classList.remove('hidden');
            setLoading(false);
        }

        async function callGeminiAPI(team1, team2, tournament) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            // --- 3. Constructing the Prompt with the User's Complex Formula Logic ---
            const userQuery = `
                You are performing a complex, multi-step calculation for a football match between Team 1: ${team1} (Home) and Team 2: ${team2} (Away) in the ${tournament}.

                You MUST use the Google Search tool extensively to find the numerical values for all variables. If a variable is a percentage, convert it to a decimal (e.g., 40% becomes 0.40). You must use the most recent data available.

                Step A: Data Collection (Find and list all these numerical values):
                1. Average goals conceded by ${team1} in historic H2H matches against ${team2}. (Value A_avg)
                2. Highest number of goals conceded by ${team1} in a single historic H2H match against ${team2}. (Value A_high)
                3. Average goals conceded by ${team2} in historic H2H matches against ${team1}. (Value B_avg)
                4. Highest number of goals conceded by ${team2} in a single historic H2H match against ${team1}. (Value B_high)
                5. Highest number of goals scored by EITHER team in a single historic H2H match. (Value C)
                6. Average goals scored by ${team1} in the current ${tournament} season. (Value D)
                7. Highest number of goals scored by ${team1} in a single match in the current ${tournament} season. (Value D_high)
                8. Average goals scored by ${team2} in the current ${tournament} season. (Value E)
                9. Highest number of goals scored by ${team2} in a single match in the current ${tournament} season. (Value E_high)
                10. Average goals conceded by ${team1} in the current ${tournament} season. (Value F)
                11. Average goals conceded by ${team2} in the current ${tournament} season. (Value G)
                12. Average of (Percentage goal scored 1st half for ${team1} + Percentage goal scored 1st half for ${team2}). Use a decimal value. (Value H)
                13. Average of (Percentage goal scored 2nd half for ${team1} + Percentage goal scored 2nd half for ${team2}). Use a decimal value. (Value I)
                
                Step B: Intermediate Variables (Perform these sub-calculations):
                * Calculate 'a': $a = A_{avg} \times A_{high}$
                * Calculate 'b': $b = B_{avg} \times B_{high}$
                * Calculate 'd': $d = D \times D_{high}$
                * Calculate 'e': $e = E \times E_{high}$

                Step C: The Full Calculation (Follow the user's formula exactly):
                1. Calculate 's': $s = (a + b + d + e + F + G) / 100$
                2. Calculate 'w' and 'y': $w = s \times H$ and $y = s \times I$
                3. Calculate 'z': $z = (w + y) / C$
                4. Calculate 'm': $m = z + C$
                5. Calculate the Goal Range Index 'R': $R = m + 0.5$

                Final Output Requirement:
                1. List the final calculated value of R, rounded to two decimal places.
                2. State the final Goal Range prediction clearly in this format: "The Goal Range Index is $R \approx \text{XX.XX}$. The predicted goal range is **Under XX goals** (where XX is R rounded up to the nearest whole number)."
                3. Briefly list the calculated numerical values for a, b, d, e, F, G, H, I, and C that you used in the final calculation.
            `;

            const systemPrompt = "You are a highly precise and detailed statistical analysis engine. Your task is to execute the user's custom, multi-variable goal prediction formula using current, verified data obtained through Google Search. You must show the final Index value (R) and the predicted goal range.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            // Implementation of Exponential Backoff for robust API calls
            const maxRetries = 5;
            let currentDelay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        if (i < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, currentDelay));
                            currentDelay *= 2; // Exponential backoff
                            continue;
                        } else {
                            throw new Error('API rate limit exceeded after multiple retries.');
                        }
                    }

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API returned status ${response.status}: ${errorData.error?.message || 'Unknown error'}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        // 1. Extract the generated text
                        const text = candidate.content.parts[0].text;
                        predictionOutput.innerHTML = text.replace(/\n/g, '<br>');

                        // 2. Extract grounding sources
                        let sources = [];
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);

                            if (sources.length > 0) {
                                sourcesList.innerHTML = sources.map(s =>
                                    `<li><a href="${s.uri}" target="_blank" class="text-green-600 hover:text-green-700 underline">${s.title}</a></li>`
                                ).join('');
                                citationSection.classList.remove('hidden');
                            }
                        }
                    } else {
                        displayError("The model did not return a valid prediction. This usually happens if the statistical data for one of the teams or variables is too difficult to find online.");
                    }
                    setLoading(false);
                    return; // Success, exit the retry loop
                } catch (error) {
                    console.error("Fetch attempt failed:", error);
                    displayError(`Failed to fetch data: ${error.message}. Please check your input and ensure the teams and league are well-known.`);
                    return; // Failure, exit the retry loop
                }
            }
        }
    </script>
</body>
</html>


